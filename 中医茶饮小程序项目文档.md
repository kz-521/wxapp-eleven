# 中医茶饮小程序项目文档 (ThinkPHP6 API)

## 🎯 项目概述
基于现代中医体质理论构建的新一代茶饮小程序后台系统，提供个性化体质测评、产品推荐、在线商城、订单管理等完整电商解决方案。项目采用微服务架构设计，支持高并发访问和数据安全保护。

## 🏗️ 技术架构

### 核心技术栈
| 层级 | 技术组件 | 版本要求 |
|---|---|---|
| 后端框架 | ThinkPHP6 | PHP 7.4+ |
| 数据存储 | MySQL | 5.7+ |
| 缓存系统 | Redis | 6.0+ |
| 消息队列 | Redis Queue | 原生支持 |
| 云存储 | 七牛云存储 | CDN加速 |
| 微信支付 | 微信原生SDK | V3版本 |
| AI服务 | ChatGPT/DeepSeek | RESTful接口 |

### 架构特色
- ✅ RESTful API设计 (遵循REST标准)
- ✅ JWT无状态认证 (Token有效期24小时)
- ✅ ORM数据访问层 (防止SQL注入)
- ✅ 分布式缓存策略 (Redis集群支持)
- ✅ 微服务模块化 (可独立部署)
- ✅ 七牛云CDN加速 (全球访问低延迟)

## 🔐 认证授权系统

### 微信小程序登录流程
```
小程序端 → 获取code → 服务端验证 → 生成token → 返回用户数据
```

### 核心接口
- `POST /api/v1/token/wx_login` - 微信登录授权
- `POST /api/v1/token/refresh` - Token续期
- `DELETE /api/v1/token/logout` - 用户登出

### 安全策略
- Token有效期：24小时
- 刷新机制：7天内可无感知续期
- IP绑定：同一IP可绑定多个设备
- 异常检测：暴力破解自动封锁

## 📊 数据库设计规范

### 核心表结构
| 表名称 | 主要功能 | 数据量预估 |
|---|---|---|
| qingting_user | 用户基础信息 | 100万+ |
| qingting_spu | 商品主信息 | 1万+ |
| qingting_sku | 商品规格SKU | 10万+ |
| qingting_order | 订单主表 | 500万+ |
| qingting_order_item | 订单详情 | 1000万+ |
| qingting_constitution_result | 体质测评结果 | 300万+ |
| qingting_coupon | 优惠券管理 | 50万+ |

### 索引优化策略
- 用户表：联合索引(user_id, openid)
- 订单表：复合索引(user_id, status, created_time)
- 商品表：全文索引(name, description)
- 优惠券表：联合索引(user_id, status, expire_time)

## 🛒 业务模块详解

### 1. 用户中心模块
```
功能清单：
├── 用户信息管理 (app/qingting/controller/v1/User.php)
│   ├── 获取用户信息 GET /api/v1/user/profile
│   ├── 更新用户信息 PUT /api/v1/user/profile
│   └── 上传头像 POST /api/v1/user/avatar
├── 收货地址管理
│   ├── 获取地址列表 GET /api/v1/address
│   ├── 新增地址 POST /api/v1/address
│   └── 设置默认地址 PUT /api/v1/address/default
└── 用户偏好设置
    ├── 订阅消息管理
    └── 历史浏览记录
```

### 2. 商品商城模块
```
功能架构：
├── SPU/SKU管理体系
│   ├── 商品分类浏览 GET /api/v1/category
│   ├── 商品列表查询 GET /api/v1/spu
│   ├── 商品详情查看 GET /api/v1/spu/:id
│   └── 商品规格选择 GET /api/v1/sku/:id
├── 搜索引擎
│   ├── 关键词搜索 GET /api/v1/search?q=keyword
│   ├── 筛选器功能 (价格、功效、体质)
│   └── 排序功能 (销量、价格、评分)
└── 推荐系统
    ├── 基于体质的个性化推荐
    ├── 新品推荐算法
    └── 热销商品排行
```

### 3. 中医体质测评系统
```
测评流程：
开始测评 → 填写基本信息 → 完成60道题 → AI分析结果 → 生成报告 → 推荐茶饮
```

**技术实现：**
- 题库系统：120道标准化测试题
- AI算法：基于《中医体质分类与判定》国家标准
- 报告生成：动态生成个性化体质分析报告
- 关联推荐：根据体质类型推荐对应茶饮

### 4. 订单交易系统
```
订单生命周期：
创建订单 → 支付订单 → 商家发货 → 确认收货 → 评价完成
```

**功能矩阵：**
| 功能类别 | 具体接口 |
|---|---|
| 订单管理 | POST /api/v1/order (创建订单) |
| 支付系统 | POST /api/v1/pay/unifiedorder (统一下单) |
| 物流跟踪 | GET /api/v1/order/:id/logistics |
| 订单评价 | POST /api/v1/order/:id/comment |
| 售后服务 | POST /api/v1/order/:id/refund |

### 5. 优惠券营销系统
```
优惠券类型：
├── 新人券 (注册即送)
├── 节日券 (营销活动)
├── 生日券 (用户关怀)
└── 体质券 (个性化推荐)
```

## 🚀 技术亮点实现

### 1. 高性能架构设计
- **连接池优化**: PDO长连接 + Redis集群
- **缓存策略**: 三级缓存(浏览器缓存 + CDN缓存 + 应用缓存)
- **数据库优化**: 读写分离 + 分库分表策略
- **异常处理**: 全局异常捕获 + 优雅降级

### 2. 安全防护体系
- **数据安全**: MySQL SSL连接、数据脱敏存储
- **接口安全**: IP白名单、请求频率限制、签名验证
- **支付安全**: 微信支付的完整验证流程
- **代码安全**: SQL注入防护、XSS攻击防御

### 3. 运维监控方案
- **日志系统**: ELK日志收集分析
- **性能监控**: APM应用性能监控
- **业务监控**: 订单转化率、用户活跃度实时分析
- **告警机制**: 企业微信/钉钉即时告警

## 📱 微信小程序端对接

### 页面路线图
```
首页 → 商品分类 → 商品详情 → 创建订单 → 支付成功 → 订单跟踪
```

### 核心页面技术栈
- 技术框架：原生小程序 + Taro混合开发
- UI组件：Vant Weapp (有赞组件库)
- 状态管理：MobX全局状态管理
- 网络请求：Flyio网络库封装

## 🔧 开发环境配置

### 快速启动步骤
```bash
# 1. 克隆项目和依赖安装
git clone [项目地址]
cd api-health-tp6
composer install --optimize-autoloader

# 2. 环境配置
cp .env.example .env
# 编辑.env文件配置数据库、Redis、七牛云等参数

# 3. 数据库初始化
php think migrate:run
php think seed:run

# 4. 本地启动
php think run --port=8000

# 5. 访问测试
# API文档 http://localhost:8000/api/v1/test
```

### 关键配置说明
```env
# 数据库配置
DATABASE_TYPE=mysql
DATABASE_HOST=127.0.0.1
DATABASE_NAME=qingting_api
DATABASE_USERNAME=root
DATABASE_PASSWORD=yourpassword

# Redis配置
REDIS_HOST=127.0.0.1
REDIS_PORT=6379
REDIS_PASSWORD=

# 七牛云配置(Qiniuyun)
QINIU_ACCESS_KEY=your_access_key
QINIU_SECRET_KEY=your_secret_key
QINIU_BUCKET=your_bucket_name
QINIU_DOMAIN=https://your-domain.qiniudn.com

# 微信小程序配置
WECHAT_APP_ID=your_app_id
WECHAT_SECRET=your_app_secret

# JWT密钥
JWT_SECRET=your_super_secret_key
```

## 📊 性能优化建议

### 1. 数据库层面
- ✅ 建立复合索引优化查询速度
- ✅ 合理使用读写分离架构
- ✅ 定期清理历史数据(冷数据归档)
- ✅ 使用连接池减少连接开销

### 2. 缓存策略
- ✅ 用户信息缓存(有效期2小时)
- ✅ 商品详情缓存(更新时失效)
- ✅ 营销活动规则缓存(5分钟刷新)
- ✅ 搜索结果缓存(个性化缓存)

### 3. 代码优化
- ✅ 使用OPcache缓存PHP脚本
- ✅ 合理使用异步队列处理耗时任务
- ✅ 优化SQL查询，避免N+1问题
- ✅ 使用批量操作减少网络开销

## 🎯 后续扩展方向

### 1. 商业智能分析
- 用户行为追踪系统
- 销售数据可视化大屏
- AI个性化推荐算法升级
- 会员积分体系构建

### 2. 技术服务升级
- 分布式微服务架构改造
- 容器化部署(Docker + Kubernetes)
- 云端自动扩缩容实现
- 全链路APM性能监控

### 3. 新功能拓展
- 营养师在线咨询服务
- 体质改善计划个性化定制
- 茶饮社区分享功能
- 健康打卡积分体系

### 4. 多端融合
- 支付宝小程序同步上线
- H5移动端商城优化
- PC端商家后台管理
- 数据统一管理平台

---

## 📞 技术支持

**开发团队**: 项目技术咨询请通过以下方式联系
- 技术文档: https://docs.qingtch.com
- 技术支持: support@qingtch.com
- 微信对接: wx://qingting_support

**版本管理**: 
- 当前版本: v2.0.0 (2024年稳定版)
- 更新频率: 月迭代更新 (每月第一周)
- 升级支持: 无缝在线升级机制

---

*本文档基于实际项目代码同步更新，确保技术实现的准确性和实时性。*

